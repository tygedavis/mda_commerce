services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      # Connects to the proxy service. 
      # CAUTION: Pass DATABASE_URL via .env or command line. Do not commit credentials.
      - DATABASE_URL=${DATABASE_URL:-postgres://staging_user:PASSWORD_PLACEHOLDER@proxy:5432/gallery_staging}
    depends_on:
      - proxy

  proxy:
    image: gcr.io/cloudsql-docker/gce-proxy:1.33.2
    command: /cloud_sql_proxy -instances=maggiedavisart:us-central1:art-gallery-db=tcp:0.0.0.0:5432 -credential_file=/secrets/key.json
    ports:
      - "5432:5432"
    volumes:
      # Mounts the key file from host
      - ./gcp-sa-key.json:/secrets/key.json:ro,z
